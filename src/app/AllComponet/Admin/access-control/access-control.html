<div class="access-control-container" dir="ltr">

  <button class="back-btn" (click)="goBack()">â† Back</button>

  <!-- Student Info Header -->
  <div class="student-header" *ngIf="SelectedStudent">
    <h2>Access Control - {{ SelectedStudent.userName }}</h2>
  </div>

  <!-- Current Permissions Display -->
  <div class="permissions-summary" *ngIf="permissions">
    <div class="summary-header">
      <h3>ğŸ“‹ Current Student Permissions</h3>
      <button class="refresh-btn" (click)="loadStudentPermissions()">
        <span>ğŸ”„</span> Refresh
      </button>
    </div>

    <div class="summary-grid">
      <!-- Granted Grades -->
      <div class="summary-card grades-card">
        <div class="card-header">
          <span class="card-icon">ğŸ“</span>
          <span class="card-title">Grades</span>
          <span class="badge">{{ getGrantedGrades().length }}</span>
        </div>
        <div class="card-content">
          <div *ngIf="getGrantedGrades().length === 0" class="empty-state">
            No permissions granted
          </div>
          <div class="permission-list">
            <div *ngFor="let grade of getGrantedGrades()" class="permission-item">
              <span class="item-name">{{ grade.gradeName }}</span>
              <button class="quick-revoke" (click)="revokeSingle('Grade', grade.id)" title="Revoke">âœ•</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Granted Terms -->
      <div class="summary-card terms-card">
        <div class="card-header">
          <span class="card-icon">ğŸ“…</span>
          <span class="card-title">Terms</span>
          <span class="badge">{{ getGrantedTerms().length }}</span>
        </div>
        <div class="card-content">
          <div *ngIf="getGrantedTerms().length === 0" class="empty-state">No permissions granted</div>
          <div class="permission-list">
            <div *ngFor="let term of getGrantedTerms()" class="permission-item">
              <span class="item-name">{{ term.termOrder === 0 ? 'First Term' : 'Second Term' }}</span>
              <button class="quick-revoke" (click)="revokeSingle('Term', term.id)" title="Revoke">âœ•</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Granted Units -->
      <div class="summary-card units-card">
        <div class="card-header">
          <span class="card-icon">ğŸ“š</span>
          <span class="card-title">Units</span>
          <span class="badge">{{ getGrantedUnits().length }}</span>
        </div>
        <div class="card-content">
          <div *ngIf="getGrantedUnits().length === 0" class="empty-state">No permissions granted</div>
          <div class="permission-list">
            <div *ngFor="let unit of getGrantedUnits()" class="permission-item">
              <span class="item-name">{{ unit.title }}</span>
              <button class="quick-revoke" (click)="revokeSingle('Unit', unit.id)" title="Revoke">âœ•</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Granted Lessons -->
      <div class="summary-card lessons-card">
        <div class="card-header">
          <span class="card-icon">ğŸ“–</span>
          <span class="card-title">Lessons</span>
          <span class="badge">{{ getGrantedLessons().length }}</span>
        </div>
        <div class="card-content">
          <div *ngIf="getGrantedLessons().length === 0" class="empty-state">No permissions granted</div>
          <div class="permission-list">
            <div *ngFor="let lesson of getGrantedLessons()" class="permission-item">
              <span class="item-name">{{ lesson.title }}</span>
              <button class="quick-revoke" (click)="revokeSingle('Lesson', lesson.id)" title="Revoke">âœ•</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Section Divider -->
  <div class="section-divider">
    <h3>ğŸ” Grant or Revoke Permissions</h3>
  </div>
  <!-- Subject Selection -->
  <!-- Subject Selection -->
<div class="subject-selection mb-4">
  <label for="subjectSelect" class="subject-label">ğŸ“š Select Subject:</label>
  <div class="subject-dropdown-wrapper">
    <select id="subjectSelect" [(ngModel)]="selectedSubjectId" (change)="onSubjectChange(selectedSubjectId)" class="subject-dropdown">
      <option [value]="0">-- All Subjects --</option>
      <option *ngFor="let subject of subjects" [value]="subject.id">{{ subject.subjectName }}</option>
    </select>
    <span class="dropdown-icon">â–¾</span>
  </div>
</div>


  <!-- Grades Accordion -->
  <div class="accordion-wrapper">
    <div *ngFor="let grade of grades" class="grade-section">

      <!-- Grade Header -->
      <div class="section-header grade-header">
        <button class="toggle-btn" (click)="grade.isOpen = !grade.isOpen; onGradeChange(grade.id)">
          <svg [class.rotated]="grade.isOpen" width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M6 8L10 12L14 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <span class="section-title">{{ grade.gradeName }}</span>
        <div class="action-buttons">
          <button class="btn-grant" (click)="grantSingle('Grade', grade.id)" [class.active]="permissions?.gradeIds?.includes(grade.id)">
            <span>Grant</span><span class="icon">âœ“</span>
          </button>
          <button class="btn-revoke" (click)="revokeSingle('Grade', grade.id)">
            <span>Revoke</span><span class="icon">ğŸš«</span>
          </button>
        </div>
      </div>

      <!-- Terms Section -->
      <div class="nested-content" *ngIf="grade.isOpen">
        <div *ngFor="let term of getTermsForGrade(grade.id)" class="term-section">

          <!-- Term Header -->
          <div class="section-header term-header">
            <button class="toggle-btn" 
            
          (click)="term.isOpen = !term.isOpen; onTermChange(term.id)">


              <svg [class.rotated]="term.isOpen" width="18" height="18" viewBox="0 0 20 20" fill="none">
                <path d="M6 8L10 12L14 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
            <span class="section-title">{{ term.termOrder === 0 ? 'First Term' : 'Second Term' }}</span>
            <span class="calendar-icon">ğŸ“…</span>
            <div class="action-buttons">
              <button class="btn-grant" (click)="grantSingle('Term', term.id)" [class.active]="permissions?.termIds?.includes(term.id)">
                <span>Grant</span><span class="icon">âœ“</span>
              </button>
              <button class="btn-revoke" (click)="revokeSingle('Term', term.id)">
                <span>Revoke</span><span class="icon">ğŸš«</span>
              </button>
            </div>
          </div>

          <!-- Units Section -->
          <div class="nested-content" *ngIf="term.isOpen">
            <div *ngFor="let unit of getUnitsForTerm(term.id)" class="unit-section">
              <div class="section-header unit-header">
                <button class="toggle-btn"
                
            (click)="unit.isOpen = !unit.isOpen; onUnitChange(unit.id)"
                
                >
                  <svg [class.rotated]="unit.isOpen" width="16" height="16" viewBox="0 0 20 20" fill="none">
                    <path d="M6 8L10 12L14 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <span class="section-title">{{ unit.title }}</span>
                <span class="book-icon">ğŸ“š</span>
                <div class="action-buttons">
                  <button class="btn-grant" (click)="grantSingle('Unit', unit.id)" [class.active]="permissions?.unitIds?.includes(unit.id)">
                    <span>Grant</span><span class="icon">âœ“</span>
                  </button>
                  <button class="btn-revoke" (click)="revokeSingle('Unit', unit.id)">
                    <span>Revoke</span><span class="icon">ğŸš«</span>
                  </button>
                </div>
              </div>

              <!-- Lessons Section -->
              <div class="nested-content" *ngIf="unit.isOpen">
                <div *ngFor="let lesson of getLessonsForUnit(unit.id)" class="lesson-section">
                  <div class="section-header lesson-header">
                    <span class="lesson-icon">ğŸ“–</span>
                    <span class="section-title">{{ lesson.title }}</span>
                    <div class="action-buttons">
                      <button class="btn-grant" (click)="grantSingle('Lesson', lesson.id)" [class.active]="permissions?.lessonIds?.includes(lesson.id)">
                        <span>Grant</span><span class="icon">âœ“</span>
                      </button>
                      <button class="btn-revoke" (click)="revokeSingle('Lesson', lesson.id)">
                        <span>Revoke</span><span class="icon">ğŸš«</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

</div>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="loading">
  <div class="spinner"></div>
  <p>Loading...</p>
</div>